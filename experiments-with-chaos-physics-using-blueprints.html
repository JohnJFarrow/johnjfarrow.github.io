
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://johnjfarrow.github.io/theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
    href="https://johnjfarrow.github.io/theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
          href="https://johnjfarrow.github.io/theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light)"
          href="https://johnjfarrow.github.io/theme/pygments/emacs.min.css">



  <link rel="stylesheet" type="text/css" href="https://johnjfarrow.github.io/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://johnjfarrow.github.io/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://johnjfarrow.github.io/theme/font-awesome/css/solid.css">

  <link rel="stylesheet" type="text/css" href="https://johnjfarrow.github.io/custom.css">

    <link href="https://johnjfarrow.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Unreal Code Atom">



  


 

<meta name="author" content="John Farrow" />
<meta name="description" content="Notes on using Chaos Physics and Blueprints in Unreal Engine" />
<meta name="keywords" content="unreal engine, chaos, physics, blueprints, blender">


  <meta property="og:site_name" content="Unreal Code"/>
  <meta property="og:title" content="Experiments With Chaos Physics - Using Blueprints"/>
  <meta property="og:description" content="Notes on using Chaos Physics and Blueprints in Unreal Engine"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://johnjfarrow.github.io/experiments-with-chaos-physics-using-blueprints.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2022-07-12 10:27:00+12:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="https://johnjfarrow.github.io/author/john-farrow.html">
  <meta property="article:section" content="unreal"/>
  <meta property="article:tag" content="unreal engine"/>
  <meta property="article:tag" content="chaos"/>
  <meta property="article:tag" content="physics"/>
  <meta property="article:tag" content="blueprints"/>
  <meta property="article:tag" content="blender"/>
  <meta property="og:image" content="">

  <title>Unreal Code &ndash; Experiments With Chaos Physics - Using Blueprints</title>

</head>
<body >
  <aside>
    <div>
      <a href="https://johnjfarrow.github.io/">
        <img src="https://johnjfarrow.github.io/theme/img/profile.png" alt="" title="">
      </a>

      <h1>
        <a href="https://johnjfarrow.github.io/"></a>
      </h1>

<p>Experimental Unreal Engine Code</p>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/johnjfarrow/" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/johnjfarrow" target="_blank">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="https://johnjfarrow.github.io/">Home</a>


      <a href="https://johnjfarrow.github.io/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="experiments-with-chaos-physics-using-blueprints">Experiments With Chaos Physics - Using&nbsp;Blueprints</h1>
    <p>
      Posted on July 12, 2022 in <a href="https://johnjfarrow.github.io/category/unreal.html">unreal</a>

    </p>
  </header>


  <div>
    <h2>Introduction</h2>
<p>This describes some initial steps in using chaos physics in Unreal Engine&nbsp;5.0.2. </p>
<p>The image 
below shows a working recreation of a medieval trebuchet built at <a href="https://en.wikipedia.org/wiki/Warwick_Castle">Warwick Castle</a>
in&nbsp;England.</p>
<p><img alt="" src="/images/chaos_001.jpg"></p>
<p>Image is from <a href="https://www.youtube.com/channel/UC89LF5ncbTZi9MukrMSN8eQ">https://www.youtube.com/channel/UC89LF5ncbTZi9MukrMSN8eQ</a></p>
<p>This article describes the steps I took to create a working trebuchet model in Unreal&nbsp;Engine.</p>
<h2>Blender&nbsp;Model</h2>
<p>The image below show an unshaded blender model of the&nbsp;trebuchet.</p>
<p><img alt="" src="/images/chaos_002.png"></p>
<p>This model is constructed of these parts:
1. the base
1. the arm
1. the counterweight
1. the&nbsp;ramp</p>
<p>Each of these was exported from Blender in <span class="caps">FBX</span> format using these&nbsp;options </p>
<p><img alt="" src="/images/chaos_003.png"></p>
<h3>Exporting at the&nbsp;Origin</h3>
<p>Before exporting it, each component was moved to the origin in Blender.  This makes it easier to
work with the meshes once they are imported into Unreal. It makes the local coordinate 
system&nbsp;meaningful.</p>
<p>Taking the arm component as an example, 
if it is centered on the world origin in Blender and then exported, in Unreal it looks
like&nbsp;this:</p>
<p><img alt="" src="/images/chaos_004.png"></p>
<p>If it is not centered on the world origin in Blender, in Unreal it looks
like&nbsp;this:</p>
<p><img alt="" src="/images/chaos_005.png"></p>
<p>The difference in the position of the arm&#8217;s origin effects how it easy it is to manipulate
once the <span class="caps">FBX</span> file has been imported as a mesh and referenced by a Static Mesh component in blueprint.  As this image shows, when the 
arm is positioned at the world origin in Blender, the
Unreal transform gizmo (using world coordinates) is centered on the arm&nbsp;origin:</p>
<p><img alt="" src="/images/chaos_006.png"></p>
<p>and when using local coordinates the Unreal transform gizmo is centered on the arm origin
and aligned parallel with the arm to make it easy to position and rotate the&nbsp;arm.</p>
<p><img alt="" src="/images/chaos_008.png"></p>
<p>If the arm is not centered on the world origin in Blender before it is exported, this is what
it looks like in&nbsp;Unreal:</p>
<p><img alt="" src="/images/chaos_007.png"></p>
<p>The Unreal transform gizmo is not positioned on the arm, making it harder to position, and
the local and world coordinate systems are the same, making it difficult to rotate without
 manually changing the pivot&nbsp;point.</p>
<h2>Using Chaos&nbsp;Physics</h2>
<p>To get to the position where we can start adding Physics Constraints, perform these steps to import the <span class="caps">FBX</span> files exported from Blender and create a blueprint trebuchet object:
- launch Unreal Editor 
- create a new project with the Games, Blank, Blueprint options
- make new folders under the &#8220;Content&#8221; folder called &#8220;Blueprints&#8221; and &#8220;Meshes&#8221;
- open the Meshes folder and drop in <a href="https://github.com/JohnJFarrow/johnjfarrow.github.io/blob/39d7370ff16e943d3db762b22bfa653119949e00/fbx/trebuchet/Arm.fbx">Arm.fbx</a>, <a href="https://github.com/JohnJFarrow/johnjfarrow.github.io/blob/39d7370ff16e943d3db762b22bfa653119949e00/fbx/trebuchet/Weight.fbx">Weight.fbx</a>, <a href="https://github.com/JohnJFarrow/johnjfarrow.github.io/blob/39d7370ff16e943d3db762b22bfa653119949e00/fbx/trebuchet/Ramp.fbx">Ramp.fbx</a>
and <a href="https://github.com/JohnJFarrow/johnjfarrow.github.io/blob/39d7370ff16e943d3db762b22bfa653119949e00/fbx/trebuchet/Base.fbx">Base.fbx</a>
- rename these meshes SM_Arm, SM_Weight, SM_Ramp, and SM_Base respectively
- in the Blueprints directory create a new blueprint derived from the Actor parent class.  Rename this BP_Trebuchet
- open  BP_Trebuchet in the blueprint editor
- add a Static Mesh component
  - rename this &#8220;Base&#8221;
  - set its static mesh property to &#8220;SM_Base&#8221;
  - set its mobility property to &#8220;Static&#8221;; this will change Collision Presets to BlockAll
- drag the Base component and drop it on the &#8220;DefaultSceneRoot&#8221; to make it the root component
- add another Static Mesh component
  - rename this &#8220;Arm&#8221;
  - set its static mesh property to &#8220;SM_Arm&#8221;
  - set Simulate Physics to checked, this will change Collision Presets to PhysicsActor
  - set its mass to 505 kg which is calculated from its volume and the density of ash 
  - set Enable Gravity to checked
  - position the arm to intersect the base axle like&nbsp;so:</p>
<p><img alt="" src="/images/chaos_009.png"></p>
<h4>Things fly&nbsp;apart</h4>
<p>If you press the Simulate button now you will see something like&nbsp;this:</p>
<p><img alt="" src="/images/chaos_010.gif"></p>
<p>What&#8217;s happening here is that the base and the arm are colliding; in their start positions they are occupying the same
space where the arm intersects the base axle.  The chaos physics solver tries to push them apart&nbsp;violently.</p>
<p>This can be prevented by adding a Physics Constraint component to&nbsp;BP_Trebuchet.</p>
<h3>Preventing Collisions:&nbsp;Constraints</h3>
<p>A Physics Constraint can apply linear and angular forces
to objects, and constrain the interactions between objects.   It can also disable collisions between
objects, which is what we want to do, so we:
- add a Physics Constraint component
- rename it &#8220;ArmBaseStopCollision&#8221;
- set Component Name 1 to &#8220;Base&#8221;
- set Component Name 2 to &#8220;Arm&#8221;
- under &#8220;Constraint Behaviour&#8221; set Disable Collision to checked
- set all the linear and angular limits to Free so this constraint does not affect the motion of the arm, like&nbsp;this:</p>
<p><img alt="" src="/images/chaos_012.png"></p>
<p>Now if you press the Simulate button now you will see something like&nbsp;this:</p>
<p><img alt="" src="/images/chaos_011.gif"></p>
<p>This is what we expect, the arm falls because gravity acts on it, and we have disabled collision with the base so the
arm falls right through the base.  (If you are using Unreal 5.0.2 you might need to close the blueprint editor window and reopen it to reset the&nbsp;simulation)</p>
<h3>Preventing Collisions:&nbsp;Channels</h3>
<p>Another way of preventing the arm and the base from colliding is to use
a custom Object Channel. We can create a custom Object Channel which represents a type of object. We assign 
this type to the base
component, and then configure the arm component not to collide with objects of this&nbsp;type.</p>
<p>From the menu choose Edit | Project Settings and 
on the left hand side choose Collision, you will see this&nbsp;screen:</p>
<p><img alt="" src="/images/chaos_031.png"></p>
<p>Click the &#8220;New Object Channel&#8221; button to create a new channel.  On the screen above
you can see we have already added a custom channel cells&nbsp;&#8220;CustomBaseChannel&#8221;</p>
<p>Edit the BP_Trebuchet blueprint and select the Base StaticMesh&nbsp;component.</p>
<p>Set the collision properties like&nbsp;this:</p>
<p><img alt="" src="/images/chaos_032.png"></p>
<p>This tells Unreal that when resolving collisions the base should be considered to 
be of type&nbsp;&#8220;CustomBaseChannel&#8221;.</p>
<p>Next select the Arm component and configure the collision properties like&nbsp;this:</p>
<p><img alt="" src="/images/chaos_033.png"></p>
<p>This tells Unreal that when the arm collides with something of the &#8220;CustomBaseChannel&#8221;
type, to ignore that&nbsp;collision.</p>
<h3>Constraining the&nbsp;Arm</h3>
<p>We want the arm to pivot around the axle.  If we change all the Linear Limits to Locked, and
change Swing 1 Motion and Swing 2 Motion to locked, leaving Twist Motion as Free, the only
way the arm can move is to pivot is around the X&nbsp;axis.</p>
<p><img alt="" src="/images/chaos_013.png"></p>
<p>Looking at the tooltip for Twist Limit it sort of explains what Twist Motion does: &#8220;Symmetric angle of roll along the X-axis&#8221;. This
tells us the Twist Motion properties control the twist around <strong>the X-axis of the constraint, not the X-Axis of the 
constrained components</strong>.  You can see this by changing the yaw angle (rotation around the local X-axis) of the constraint - at 45 degrees
the arm just tips over slightly, at 90 degrees nothing happens at&nbsp;all.</p>
<p>Looking at the image below, we can see the constraint X-axis (the red one) is pointing parallel to the axle 
which is what we&nbsp;want.</p>
<p><img alt="" src="/images/chaos_014.png"></p>
<p>If we press the Simulate button from this position the arm pivots around the position of the constraint like&nbsp;so:</p>
<p><img alt="" src="/images/chaos_014.gif"></p>
<p>If we position the constraint where the axle is like&nbsp;this:</p>
<p><img alt="" src="/images/chaos_015.png"></p>
<p>Then we get the arm swinging in the way we&nbsp;want:</p>
<p><img alt="" src="/images/chaos_016.gif"></p>
<h3>Adding the&nbsp;Counterweight</h3>
<p>Add another Static Mesh component
  - rename this &#8220;Weight&#8221;
  - set its static mesh property to &#8220;SM_Weight&#8221;
  - set Simulate Physics to checked, this will change Collision Presets to PhysicsActor
  - set its mass to 4506 kg which is calculated from its volume and the density of stone
  - set Enable Gravity to checked
  - position the weight to intersect the arm like&nbsp;so:</p>
<p><img alt="" src="/images/chaos_017.png"></p>
<p>Add a Physics Constraint component to link the weight to the arm:
- rename it &#8220;ArmWeightConstraint&#8221;
- set Component Name 1 to &#8220;Arm&#8221;
- set Component Name 2 to &#8220;Weight&#8221;
- under &#8220;Constraint Behaviour&#8221; set Disable Collision to checked
- move the constraint to where the weight is attached to the&nbsp;arm</p>
<p>Add another Physics Constraint just to stop the weight colliding with the base:
- rename it &#8220;BaseWeightConstraint&#8221;
- set Component Name 1 to &#8220;Base&#8221;
- set Component Name 2 to &#8220;Weight&#8221;
- under &#8220;Constraint Behaviour&#8221; set Disable Collision to checked
- set all the limits to Free so it does nothing but disable the&nbsp;collision:</p>
<p><img alt="" src="/images/chaos_012.png"></p>
<h3>Preventing Collisions:&nbsp;Meshes</h3>
<p>Even though we can see that the base and the weight do not collide the BaseWeightConstraint constraint
is necessary because the base is using a simple collision volume.  Open the SM_Base mesh
and click Show | Simple Collision, this shows that the base is using a collision volume which 
includes the area where the weight&nbsp;swings:</p>
<p><img alt="" src="/images/chaos_019.png"></p>
<p>An alternative to adding the BaseWeightConstraint constraint is to use the complex collision
volume for the base.  Click Show | Complex Collision to show the more complex and better
fitting collision&nbsp;volume:</p>
<p><img alt="" src="/images/chaos_020.png"></p>
<p>We can use this by changing the Collision Complexity property of the SM_Mesh to &#8220;Use Complex Collision as Simple&#8221;
which will make Unreal use the complex collision volume in all&nbsp;cases. </p>
<p>Now when simulating the weight should pull the arm down like&nbsp;so:</p>
<p><img alt="" src="/images/chaos_018.gif"></p>
<h3>Adding the&nbsp;Ramp</h3>
<p>The ramp is a separate mesh which the projectile slides along when it is launched.  It is added
by:
- adding a new Static Mesh to BP_Trebuchet component
- rename this &#8220;Ramp&#8221;
- set its static mesh property to &#8220;SM_Ramp&#8221;
- set its mobility property to &#8220;Static&#8221;; this will change Collision Presets to BlockAll
- position it like&nbsp;this:</p>
<p><img alt="" src="/images/chaos_021.png"></p>
<h3>Adding the&nbsp;Projectile</h3>
<p>The projectile is Sphere component.  In theory it could be a separate actor because there can be many
projectiles, and when they are thrown the move far away from the trebuchet, but for the purposes of learning chaos physics a component will&nbsp;suffice.</p>
<p>Add the projectile by 
- adding a new Sphere component to BP_Trebuchet component
- rename this &#8220;Ball&#8221;
- set Simulate Physics to checked, this will change Collision Presets to PhysicsActor
- set its mass to 15 kg 
- set Enable Gravity to checked
- position it on the ramp like&nbsp;this:</p>
<p><img alt="" src="/images/chaos_022.png"></p>
<p>When the real trebuchet fires the arm is positioned close to the ground as shown in the 
top picture, so rotate the arm to a similar position like&nbsp;this:</p>
<p><img alt="" src="/images/chaos_023.png"></p>
<p>We will use a Physics Constraint to represent the connection between the arm and the ball.  So:
- add a Physics Constraint component
- rename it &#8220;CableConstraint&#8221;
- set Component Name 1 to &#8220;Arm&#8221;
- set Component Name 2 to &#8220;Ball&#8221;
- under &#8220;Constraint Behaviour&#8221; set Disable Collision to checked
- set all the linear limits to Locked and all the angular limits to Free
- position the constraint at the end of the arm like&nbsp;this:</p>
<p><img alt="" src="/images/chaos_024.png"></p>
<p>Now pressing Play in the editor should result in this&nbsp;motion:</p>
<p><img alt="" src="/images/chaos_025.gif"></p>
<h3>Releasing the&nbsp;Projectile</h3>
<p>The ball swings in the manner we want, but it remains connected to the arm.  We need to find a way to break
the constraint connecting the ball to the arm.  There are several ways to do this, we could for example:
- break the constraint when the ball enters a certain area
- break the constraint when the ball is travelling at a certain angle
- break the constraint when the ball is travelling at a certain&nbsp;velocity</p>
<p>We can visualize the velocity using a blueprint like&nbsp;this:</p>
<p><img alt="" src="/images/chaos_026.png"></p>
<p>Assuming the trebuchet is aligned to fire down the X-axis, when the velocity in the X direction is greater than zero this blueprint will:
- draw a vector representing the velocity of the ball, so a longer line represents a greater velocity
- print the angle of the velocity at the end of each&nbsp;vector</p>
<p>The output looks like&nbsp;this:</p>
<p><img alt="" src="/images/chaos_027.gif"></p>
<p>This is the last&nbsp;frame:</p>
<p><img alt="" src="/images/chaos_028.png"></p>
<p>If we arbitrarily decide to fire when the angle is about 45 degrees, we can calculate the angle of the projectile from the velocity, and break the constraint between the arm and the ball as soon as the angle is &lt;= 45&nbsp;degrees.</p>
<p>We update the blueprint by adding a variable to track if the constraint has been broken, 
and break the constraint the first time the angle is &lt;= 45&nbsp;degrees:</p>
<p><img alt="" src="/images/chaos_029.png"></p>
<p>And we get this&nbsp;result:</p>
<p><img alt="" src="/images/chaos_030.gif"></p>
<h3>References</h3>
<p><a href="https://docs.unrealengine.com/5.0/en-US/add-a-custom-object-type-to-your-project-in-unreal-engine/">Custom Channels -&nbsp;https://docs.unrealengine.com</a></p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://johnjfarrow.github.io/tag/unreal-engine.html">unreal engine</a>
      <a href="https://johnjfarrow.github.io/tag/chaos.html">chaos</a>
      <a href="https://johnjfarrow.github.io/tag/physics.html">physics</a>
      <a href="https://johnjfarrow.github.io/tag/blueprints.html">blueprints</a>
      <a href="https://johnjfarrow.github.io/tag/blender.html">blender</a>
    </p>
  </div>






</article>

    <footer>
<p>
  &copy; 2022  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses//4.0/deed.en_US" target="_blank">Creative Commons Attribution-ShareAlike</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="https://johnjfarrow.github.io/theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="dark"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses//4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l//4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Unreal Code ",
  "url" : "https://johnjfarrow.github.io",
  "image": "",
  "description": ""
}
</script>

  
</body>
</html>