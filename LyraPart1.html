
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <script type="text/javascript">
  function putEmail() {
    var domain = 'unrealcode.net';
    var user = 'john.farrow';
    element = document.getElementById('email');
    element.innerHTML = user + '@' + domain;
  }
  </script>


    <link rel="stylesheet" type="text/css" href="/theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
    href="/theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
          href="/theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light)"
          href="/theme/pygments/emacs.min.css">



  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/solid.css">

  <link rel="stylesheet" type="text/css" href="/custom.css">




  


 

<meta name="author" content="John Farrow" />
<meta name="description" content="Looking at how the Epic Lyra example manages different game modes and handles loading assets for each game mode" />
<meta name="keywords" content="unreal engine, lyra">


  <meta property="og:site_name" content="Unreal Code"/>
  <meta property="og:title" content="Looking into Lyra - Part 1 - Experiences"/>
  <meta property="og:description" content="Looking at how the Epic Lyra example manages different game modes and handles loading assets for each game mode"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="/LyraPart1.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2022-08-02 00:00:00+12:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="/author/john-farrow.html">
  <meta property="article:section" content="unreal"/>
  <meta property="article:tag" content="unreal engine"/>
  <meta property="article:tag" content="lyra"/>
  <meta property="og:image" content="">

  <title>Unreal Code &ndash; Looking into Lyra - Part 1 - Experiences</title>

</head>
<body onload="putEmail();" >
  <aside>
    <div>
      <a href="/">
        <img src="/theme/img/profile.png" alt="Experiments with Unreal Engine" title="Experiments with Unreal Engine">
      </a>

      <h1>
        <a href="/">Experiments with Unreal Engine</a>
      </h1>

<p>John Farrow</p>
      <p id="email">EMAIL</p>
       <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/johnjfarrow/" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/johnjfarrow" target="_blank">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="/">Home</a>



    </nav>

<article class="single">
  <header>
      
    <h1 id="LyraPart1">Looking into Lyra - Part 1 -&nbsp;Experiences</h1>
    <p>
      Posted on August 02, 2022 in <a href="/category/unreal.html">unreal</a>

    </p>
  </header>


  <div>
    <h2>Introduction</h2>
<p>The aim of this is to examine the source code from the Lyra example provided by Epic Games
and to try and identify and document practices and approaches for using&nbsp;c++.</p>
<h2>Experiences</h2>
<p><span class="dquo">&#8220;</span>Experience&#8221; is the term Lyra uses for game modes such as first person, top down&nbsp;etc.</p>
<h3>Data&nbsp;Classes</h3>
<p>An experience is represented in code by two distinct&nbsp;classes:</p>
<ul>
<li><code>ULyraExperienceDefinition</code> which holds data properties and references to objects such as the Lyra pawn, actions and action&nbsp;sets</li>
<li><code>ULyraUserFacingExperienceDefinition</code> which is a lighter weight object which holds
the IDs (of type <code>FPrimaryAssetId</code>) of maps and experiences together with references to <span class="caps">UI</span>&nbsp;widgets.  </li>
</ul>
<p>Because the <code>ULyraUserFacingExperienceDefinition</code> holds IDs and not references it can be loaded 
without loading the experience to which it refers and so without loading other
assets used by that experience.  This means (a) it is quick to create the opening experience selection <span class="caps">UI</span>
and (b) it avoids loading experiences and their assets when those assets may not be&nbsp;required.</p>
<h3>Experience&nbsp;Blueprints</h3>
<p>Experience blueprints such as B_LyraDefaultExperience extend the c++ class <code>ULyraExperienceDefinition</code>. </p>
<p>The B_LyraDefaultExperience blueprint is data&nbsp;only:</p>
<p><img alt="" src="/images/lyra_003.png"></p>
<p>It&nbsp;holds:</p>
<ul>
<li>the pawn class for that experience: <code>TSubclassOf&lt;APawn&gt;</code></li>
<li>
<p>default camera mode used by player controlled pawns: <code>TSubclassOf&lt;ULyraCameraMode&gt;</code></p>
</li>
<li>
<p>input configuration used by player controlled pawns to create input mappings and bind input actions: <code>ULyraInputConfig* InputConfig</code></p>
</li>
<li>
<p><span class="dquo">&#8220;</span>action sets&#8221; which are (from the c++ comments) &#8220;ability sets to grant to this pawn&#8217;s ability system&#8221;: <code>TArray&lt;ULyraAbilitySet*&gt;</code>.  A <code>ULyraAbilitySet</code> is a non-mutable data asset used to grant gameplay abilities and gameplay&nbsp;effects</p>
</li>
<li>
<p>the mapping of ability tags to use for actions taking by this pawn: <code>ULyraAbilityTagRelationshipMapping* TagRelationshipMapping</code>, i.e. a mapping of how ability tags block or cancel other&nbsp;abilities</p>
</li>
</ul>
<p>To get an idea what is actually stored in an experience object, we can look at it in the
debugger.  This shows the&nbsp;actions:</p>
<p><img alt="" src="/images/lyra_010.png"></p>
<p>And this shows the action&nbsp;sets:</p>
<p><img alt="" src="/images/lyra_011.png"></p>
<h3>Default&nbsp;Map</h3>
<p>When starting with the default map (/Game/System/DefaultEditorMap/L_DefaultEditorOverview),
the level contains a blueprint (/Game/System/DefaultEditorMap/B_ExperienceList3D)
which creates the display of possible experiences, so the user is presented with <span class="caps">UI</span> for choosing which experience they&nbsp;want:</p>
<p><img alt="" src="/images/lyra_004.png"></p>
<p>The list created by B_ExperienceList3D is a list of <code>ULyraUserFacingExperienceDefinition</code>.  B_ExperienceList3D uses this&nbsp;blueprint: </p>
<p><img alt="" src="/images/lyra_006.png"></p>
<p>It&nbsp;includes:</p>
<ul>
<li>a Get Primary Asset Id List node to get the list of Primary Asset Ids which are of type&nbsp;LyraUserFacingExperienceDefinition </li>
<li>an Async Load Primary Asset List node to load array of LyraUserFacingExperienceDefinition&nbsp;objects</li>
</ul>
<p>Using <code>Tools | Search</code> and searching for &#8220;LyraUserFacingExperienceDefinition&#8221; shows all the data assets of 
the experience&nbsp;type:</p>
<p><img alt="" src="/images/lyra_005.png"></p>
<p>These are the source of the list of data asset ids returned from the Get Primary Asset Id List&nbsp;node.</p>
<h3>Async&nbsp;Loading</h3>
<p>The full blueprint which executes when the B_ExperienceList3D object gets the BeginPlay event is shown&nbsp;here:</p>
<p><img alt="" src="/images/lyra_008.png"></p>
<p>The vertical green line shows where the Async Load Primary Asset List is.  Everything to the left side of this line
happens when the BeginPlay event is triggered, everything on the right side of the line happens asynchronously.  Nothing is waiting on the right side nodes because all they do is populate some <span class="caps">UI</span>&nbsp;elements.</p>
<h3>Discovery</h3>
<p>If configured to do so, Unreal will discover any objects of type &#8220;LyraUserFacingExperienceDefinition&#8221; which are added
to the project.  This is done using the <code>Edit | Project Settings...</code> menu option and selecting <code>Asset Manager</code>
on the left hand side.  The screenshot below shows how the project is&nbsp;configured:</p>
<p><img alt="" src="/images/lyra_007.png"></p>
<h3>Starting an&nbsp;Experience</h3>
<p>In Lyra experiences equate to game modes such as the main menu, the core shooter mode, the top down arena mode&nbsp;etc.</p>
<p>Lyra has a <code>ULyraExperienceManagerComponent</code> component which manages the 
launching of experiences with methods such as <code>StartExperienceLoad()</code> and <code>OnExperienceFullLoadCompleted()</code></p>
<p><img alt="" src="/images/lyra_009.png"></p>
<p>When an experience is selected from the opening level <code>LyraExperienceManagerComponent::StartExperienceLoad()</code>
is called.  This&nbsp;method:</p>
<ul>
<li>gets the primary asset id of any <code>ULyraExperienceActionSets</code> associated with the&nbsp;experience</li>
<li>identified any asset bundles to load, such as &#8220;Client&#8221;, &#8220;Server&#8221; or&nbsp;&#8220;Equipped&#8221;</li>
<li>creates a delegate to call <code>OnExperienceLoadComplete()</code> once the async asset loading
has&nbsp;completed</li>
</ul>
<p>Then it starts the async loading of identified assets with these&nbsp;lines:</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">TSharedPtr</span><span class="o">&lt;</span><span class="n">FStreamableHandle</span><span class="o">&gt;</span><span class="w"> </span><span class="n">BundleLoadHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">      </span><span class="n">AssetManager</span><span class="p">.</span><span class="n">ChangeBundleStateForPrimaryAssets</span><span class="p">(</span><span class="w"> </span><span class="n">BundleAssetList</span><span class="p">.</span><span class="n">Array</span><span class="p">(),</span><span class="w"> </span>
<span class="w">                                                      </span><span class="n">BundlesToLoad</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                      </span><span class="n">FStreamableDelegate</span><span class="p">(),</span><span class="w"> </span>
<span class="w">                                                      </span><span class="n">FStreamableManager</span><span class="o">::</span><span class="n">AsyncLoadHighPriority</span><span class="p">);</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">TSharedPtr</span><span class="o">&lt;</span><span class="n">FStreamableHandle</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RawLoadHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">      </span><span class="n">AssetManager</span><span class="p">.</span><span class="n">LoadAssetList</span><span class="p">(</span><span class="w"> </span><span class="n">RawAssetList</span><span class="p">.</span><span class="n">Array</span><span class="p">(),</span><span class="w"> </span>
<span class="w">                                  </span><span class="n">FStreamableDelegate</span><span class="p">(),</span><span class="w"> </span>
<span class="w">                                  </span><span class="n">FStreamableManager</span><span class="o">::</span><span class="n">AsyncLoadHighPriority</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                  </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;StartExperienceLoad()&quot;</span><span class="p">));</span><span class="w"></span>
</code></pre></div>

<p>Once the load is completed <code>OnExperienceLoadComplete()</code> is called.&nbsp;This:</p>
<ul>
<li>identifies game features which have been loaded in plugins by calling <code>CollectGameFeaturePluginURLs()</code></li>
<li>loads and actives those plugins by calling <code>LoadAndActivateGameFeaturePlugin()</code></li>
</ul>
<p>The <code>UGameFeaturesSubsystem</code> subsystem object is&nbsp;used:</p>
<ul>
<li>resolve plugin names such as &#8220;ShooterCore&#8221; to plugin files such as&nbsp;&#8220;../Plugins/GameFeatures/ShooterCore/ShooterCore.uplugin&#8221;</li>
<li>load files using a call to <code>LoadAndActivateGameFeaturePlugin()</code></li>
</ul>
<h2>Summary</h2>
<p>So what about this approach is beneficial and could be reused on other&nbsp;projects?</p>
<ul>
<li>the data assets are split.  An experience object (a <code>LyraExperienceDefinition</code>) is represented in the <span class="caps">UI</span> by a corresponding
<code>LyraUserFacingExperienceDefinition</code> object. The <code>LyraUserFacingExperienceDefinition</code> objects only reference a picture of the map (in a texture) so
presenting the map on the level select screen does not mean loading the actual map
and all the assets it&nbsp;contains</li>
<li>the data assets hold IDs for the related map and the experience, not 
references, so the data assets can be loaded without loading the&nbsp;maps</li>
<li>the data assets such as maps and objects using in an experience are stored by in the <code>LyraExperienceDefinition</code>
and automatically discovered by the engine.  This facilitates adding a new game mode without
changing any of the Lyra&nbsp;code</li>
</ul>
<h2>References</h2>
<p><a href="https://docs.unrealengine.com/5.0/en-US/asset-management-in-unreal-engine/">Epic: Asset Management</a>   (https://docs.unrealengine.com)<br>
<a href="https://youtu.be/9MGHBU5eNu0?t=1235">Epic: Asset Loading Best Practices</a>  (https://youtu.be/) <br>
<a href="https://www.tomlooman.com/unreal-engine-asset-manager-async-loading/">Tom Looman: Async Asset Loading</a>&nbsp;(https://www.tomlooman.com)  </p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/unreal-engine.html">unreal engine</a>
      <a href="/tag/lyra.html">lyra</a>
    </p>
  </div>






</article>

    <footer>
<p>
  &copy; 2022  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses//4.0/deed.en_US" target="_blank">Creative Commons Attribution-ShareAlike</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="/theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="dark"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses//4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l//4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Unreal Code ",
  "url" : "",
  "image": "",
  "description": ""
}
</script>

  
</body>
</html>