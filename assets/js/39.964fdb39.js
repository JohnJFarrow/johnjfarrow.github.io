(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{324:function(e,t,a){"use strict";a.r(t);var s=a(14),n=Object(s.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",[e._v(e._s(this.$page.title))]),e._v(" "),t("h2",{attrs:{id:"introduction"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#introduction"}},[e._v("#")]),e._v(" Introduction")]),e._v(" "),t("p",[e._v("The aim of this is to examine the source code from the Lyra example provided by Epic Games\nand to try and identify and document practices and approaches for using c++.")]),e._v(" "),t("h2",{attrs:{id:"experiences"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#experiences"}},[e._v("#")]),e._v(" Experiences")]),e._v(" "),t("p",[e._v('"Experience" is the term Lyra uses for game modes such as first person, top down etc.')]),e._v(" "),t("h3",{attrs:{id:"data-classes"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#data-classes"}},[e._v("#")]),e._v(" Data Classes")]),e._v(" "),t("p",[e._v("An experience is represented in code by two distinct classes:")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("ULyraExperienceDefinition")]),e._v(" which holds data properties and references to objects such as the Lyra pawn, actions and action sets")]),e._v(" "),t("li",[t("code",[e._v("ULyraUserFacingExperienceDefinition")]),e._v(" which is a lighter weight object which holds\nthe IDs (of type "),t("code",[e._v("FPrimaryAssetId")]),e._v(") of maps and experiences together with references to UI widgets.")])]),e._v(" "),t("p",[e._v("Because the "),t("code",[e._v("ULyraUserFacingExperienceDefinition")]),e._v(" holds IDs and not references it can be loaded\nwithout loading the experience to which it refers and so without loading other\nassets used by that experience.  This means (a) it is quick to create the opening experience selection UI\nand (b) it avoids loading experiences and their assets when those assets may not be required.")]),e._v(" "),t("h3",{attrs:{id:"experience-blueprints"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#experience-blueprints"}},[e._v("#")]),e._v(" Experience Blueprints")]),e._v(" "),t("p",[e._v("Experience blueprints such as B_LyraDefaultExperience extend the c++ class "),t("code",[e._v("ULyraExperienceDefinition")]),e._v(".")]),e._v(" "),t("p",[e._v("The B_LyraDefaultExperience blueprint is data only:")]),e._v(" "),t("p",[t("img",{attrs:{src:"/images/lyra_003.png",alt:""}})]),e._v(" "),t("p",[e._v("It holds:")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("the pawn class for that experience: "),t("code",[e._v("TSubclassOf<APawn>")])])]),e._v(" "),t("li",[t("p",[e._v("default camera mode used by player controlled pawns: "),t("code",[e._v("TSubclassOf<ULyraCameraMode>")])])]),e._v(" "),t("li",[t("p",[e._v("input configuration used by player controlled pawns to create input mappings and bind input actions: "),t("code",[e._v("ULyraInputConfig* InputConfig")])])]),e._v(" "),t("li",[t("p",[e._v('"action sets" which are (from the c++ comments) "ability sets to grant to this pawn\'s ability system": '),t("code",[e._v("TArray<ULyraAbilitySet*>")]),e._v(".  A "),t("code",[e._v("ULyraAbilitySet")]),e._v(" is a non-mutable data asset used to grant gameplay abilities and gameplay effects")])]),e._v(" "),t("li",[t("p",[e._v("the mapping of ability tags to use for actions taking by this pawn: "),t("code",[e._v("ULyraAbilityTagRelationshipMapping* TagRelationshipMapping")]),e._v(", i.e. a mapping of how ability tags block or cancel other abilities")])])]),e._v(" "),t("p",[e._v("To get an idea what is actually stored in an experience object, we can look at it in the\ndebugger.  This shows the actions:")]),e._v(" "),t("p",[t("img",{attrs:{src:"/images/lyra_010.png",alt:""}})]),e._v(" "),t("p",[e._v("And this shows the action sets:")]),e._v(" "),t("p",[t("img",{attrs:{src:"/images/lyra_011.png",alt:""}})]),e._v(" "),t("h3",{attrs:{id:"default-map"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#default-map"}},[e._v("#")]),e._v(" Default Map")]),e._v(" "),t("p",[e._v("When starting with the default map (/Game/System/DefaultEditorMap/L_DefaultEditorOverview),\nthe level contains a blueprint (/Game/System/DefaultEditorMap/B_ExperienceList3D)\nwhich creates the display of possible experiences, so the user is presented with UI for choosing which experience they want:")]),e._v(" "),t("p",[t("img",{attrs:{src:"/images/lyra_004.png",alt:""}})]),e._v(" "),t("p",[e._v("The list created by B_ExperienceList3D is a list of "),t("code",[e._v("ULyraUserFacingExperienceDefinition")]),e._v(".  B_ExperienceList3D uses this blueprint:")]),e._v(" "),t("p",[t("img",{attrs:{src:"/images/lyra_006.png",alt:""}})]),e._v(" "),t("p",[e._v("It includes:")]),e._v(" "),t("ul",[t("li",[e._v("a Get Primary Asset Id List node to get the list of Primary Asset Ids which are of type LyraUserFacingExperienceDefinition")]),e._v(" "),t("li",[e._v("an Async Load Primary Asset List node to load array of LyraUserFacingExperienceDefinition objects")])]),e._v(" "),t("p",[e._v("Using "),t("code",[e._v("Tools | Search")]),e._v(' and searching for "LyraUserFacingExperienceDefinition" shows all the data assets of\nthe experience type:')]),e._v(" "),t("p",[t("img",{attrs:{src:"/images/lyra_005.png",alt:""}})]),e._v(" "),t("p",[e._v("These are the source of the list of data asset ids returned from the Get Primary Asset Id List node.")]),e._v(" "),t("h3",{attrs:{id:"async-loading"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#async-loading"}},[e._v("#")]),e._v(" Async Loading")]),e._v(" "),t("p",[e._v("The full blueprint which executes when the B_ExperienceList3D object gets the BeginPlay event is shown here:")]),e._v(" "),t("p",[t("img",{attrs:{src:"/images/lyra_008.png",alt:""}})]),e._v(" "),t("p",[e._v("The vertical green line shows where the Async Load Primary Asset List is.  Everything to the left side of this line\nhappens when the BeginPlay event is triggered, everything on the right side of the line happens asynchronously.  Nothing is waiting on the right side nodes because all they do is populate some UI elements.")]),e._v(" "),t("h3",{attrs:{id:"discovery"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#discovery"}},[e._v("#")]),e._v(" Discovery")]),e._v(" "),t("p",[e._v('If configured to do so, Unreal will discover any objects of type "LyraUserFacingExperienceDefinition" which are added\nto the project.  This is done using the '),t("code",[e._v("Edit | Project Settings...")]),e._v(" menu option and selecting "),t("code",[e._v("Asset Manager")]),e._v("\non the left hand side.  The screenshot below shows how the project is configured:")]),e._v(" "),t("p",[t("img",{attrs:{src:"/images/lyra_007.png",alt:""}})]),e._v(" "),t("h3",{attrs:{id:"starting-an-experience"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#starting-an-experience"}},[e._v("#")]),e._v(" Starting an Experience")]),e._v(" "),t("p",[e._v("In Lyra experiences equate to game modes such as the main menu, the core shooter mode, the top down arena mode etc.")]),e._v(" "),t("p",[e._v("Lyra has a "),t("code",[e._v("ULyraExperienceManagerComponent")]),e._v(" component which manages the\nlaunching of experiences with methods such as "),t("code",[e._v("StartExperienceLoad()")]),e._v(" and "),t("code",[e._v("OnExperienceFullLoadCompleted()")])]),e._v(" "),t("p",[t("img",{attrs:{src:"/images/lyra_009.png",alt:""}})]),e._v(" "),t("p",[e._v("When an experience is selected from the opening level "),t("code",[e._v("LyraExperienceManagerComponent::StartExperienceLoad()")]),e._v("\nis called.  This method:")]),e._v(" "),t("ul",[t("li",[e._v("gets the primary asset id of any "),t("code",[e._v("ULyraExperienceActionSets")]),e._v(" associated with the experience")]),e._v(" "),t("li",[e._v('identified any asset bundles to load, such as "Client", "Server" or "Equipped"')]),e._v(" "),t("li",[e._v("creates a delegate to call "),t("code",[e._v("OnExperienceLoadComplete()")]),e._v(" once the async asset loading\nhas completed")])]),e._v(" "),t("p",[e._v("Then it starts the async loading of identified assets with these lines:")]),e._v(" "),t("div",{staticClass:"language-cpp line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-cpp"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" TSharedPtr"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("FStreamableHandle"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" BundleLoadHandle "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" \n      AssetManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("ChangeBundleStateForPrimaryAssets")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v(" BundleAssetList"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("Array")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" \n                                                      BundlesToLoad"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" \n                                                      "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("FStreamableDelegate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" \n                                                      FStreamableManager"),t("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[e._v("::")]),e._v("AsyncLoadHighPriority"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" TSharedPtr"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("FStreamableHandle"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" RawLoadHandle "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" \n      AssetManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("LoadAssetList")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v(" RawAssetList"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("Array")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" \n                                  "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("FStreamableDelegate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" \n                                  FStreamableManager"),t("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[e._v("::")]),e._v("AsyncLoadHighPriority"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" \n                                  "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("TEXT")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"StartExperienceLoad()"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br"),t("span",{staticClass:"line-number"},[e._v("9")]),t("br"),t("span",{staticClass:"line-number"},[e._v("10")]),t("br"),t("span",{staticClass:"line-number"},[e._v("11")]),t("br")])]),t("p",[e._v("Once the load is completed "),t("code",[e._v("OnExperienceLoadComplete()")]),e._v(" is called. This:")]),e._v(" "),t("ul",[t("li",[e._v("identifies game features which have been loaded in plugins by calling "),t("code",[e._v("CollectGameFeaturePluginURLs()")])]),e._v(" "),t("li",[e._v("loads and actives those plugins by calling "),t("code",[e._v("LoadAndActivateGameFeaturePlugin()")])])]),e._v(" "),t("p",[e._v("The "),t("code",[e._v("UGameFeaturesSubsystem")]),e._v(" subsystem object is used:")]),e._v(" "),t("ul",[t("li",[e._v('resolve plugin names such as "ShooterCore" to plugin files such as "../Plugins/GameFeatures/ShooterCore/ShooterCore.uplugin"')]),e._v(" "),t("li",[e._v("load files using a call to "),t("code",[e._v("LoadAndActivateGameFeaturePlugin()")])])]),e._v(" "),t("h2",{attrs:{id:"summary"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#summary"}},[e._v("#")]),e._v(" Summary")]),e._v(" "),t("p",[e._v("So what about this approach is beneficial and could be reused on other projects?")]),e._v(" "),t("ul",[t("li",[e._v("the data assets are split.  An experience object (a "),t("code",[e._v("LyraExperienceDefinition")]),e._v(") is represented in the UI by a corresponding\n"),t("code",[e._v("LyraUserFacingExperienceDefinition")]),e._v(" object. The "),t("code",[e._v("LyraUserFacingExperienceDefinition")]),e._v(" object\nholds only a reference to a picture of the map (in a texture), so\npresenting the map on the level select screen does not mean loading the actual map\nand all the assets it contains")]),e._v(" "),t("li",[e._v("the data assets hold IDs for the related map and the experience, not\nreferences, so the data assets can be loaded without loading the maps")]),e._v(" "),t("li",[e._v("the data assets such as maps and objects using in an experience are stored by in the "),t("code",[e._v("LyraExperienceDefinition")]),e._v("\nand automatically discovered by the engine.  This facilitates adding a new game mode without\nchanging any of the Lyra code")])]),e._v(" "),t("h2",{attrs:{id:"references"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[e._v("#")]),e._v(" References")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://docs.unrealengine.com/5.0/en-US/asset-management-in-unreal-engine/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Epic: Asset Management"),t("OutboundLink")],1),e._v("   (https://docs.unrealengine.com)"),t("br"),e._v(" "),t("a",{attrs:{href:"https://youtu.be/9MGHBU5eNu0?t=1235",target:"_blank",rel:"noopener noreferrer"}},[e._v("Epic: Asset Loading Best Practices"),t("OutboundLink")],1),e._v("  (https://youtu.be/)"),t("br"),e._v(" "),t("a",{attrs:{href:"https://www.tomlooman.com/unreal-engine-asset-manager-async-loading/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Tom Looman: Async Asset Loading"),t("OutboundLink")],1),e._v(" (https://www.tomlooman.com)")])])}),[],!1,null,null,null);t.default=n.exports}}]);